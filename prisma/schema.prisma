generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

// fellows who conduct therapy sessions
model Fellow {
  id        String   @id @default(cuid())
  name      String
  email     String   @unique
  age       Int?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  sessions Session[]

  @@map("fellows")
}

// therapy sessions conducted by fellows
model Session {
  id         String   @id @default(cuid())
  groupId    String // group identifier for the therapy session
  date       DateTime @default(now())
  transcript String   @db.Text // session transcript
  duration   Int // session in mins
  concept    String // session topic e.g peer pressure

  status SessionStatus @default(PROCESSED)

  fellowId String
  fellow   Fellow     @relation(fields: [fellowId], references: [id], onDelete: Cascade)
  analysis Analysis?
  feedback Feedback[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([fellowId])
  @@index([status])
  @@index([date])
  @@map("sessions")
}

// AI-generated analysis for each session with shamiri grading rubric (1-3)
model Analysis {
  id String @id @default(cuid())

  overallSummary String @db.Text

  // metric 1: content coverage 
  contentCoverageScore         Int // 1=Missed, 2=Partial, 3=Complete
  contentCoverageJustification String  @db.Text
  contentCoverageQuotes        String? @db.Text

  // metric 2: facilitation quality
  facilitationQualityScore         Int // 1=Poor, 2=Adequate, 3=Excellent
  facilitationQualityJustification String  @db.Text
  facilitationQualityQuotes        String? @db.Text

  // metric 3: protocol safety 
  protocolSafetyScore         Int // 1=Violation, 2=Minor Drift, 3=Adherent
  protocolSafetyJustification String  @db.Text
  protocolSafetyQuotes        String? @db.Text
  safetyFlag                  Boolean @default(false)

  // risk detection (CRITICAL - separate from protocol safety)
  riskLevel  RiskLevel @default(SAFE)
  riskQuote  String?   @db.Text
  riskReason String?   @db.Text

  // AI metadata i.e model infor used i'm using openAi gpt-5
  generatedAt    DateTime @default(now())
  modelUsed      String
  processingTime Int

  sessionId String  @unique
  session   Session @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([riskLevel])
  @@index([safetyFlag])
  @@map("analyses")
}

// supervisor feedback and overrides
model Feedback {
  id String @id @default(cuid())

  // supervisor validation (with validated or rejected AI output)
  validated Boolean
  rejected  Boolean @default(false)

  // supervisor override for session status or risk assessment
  overrideStatus SessionStatus?
  overrideRisk   RiskLevel?

  // supervisor notes
  notes          String? @db.Text
  supervisorName String

  sessionId String
  session   Session @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([sessionId])
  @@map("feedback")
}

// session status enums for AI analysis
enum SessionStatus {
  PROCESSED // completed, no issues
  FLAGGED_FOR_REVIEW // needs supervisor review
  SAFE // confirmed safe
  NEEDS_FOLLOWUP // additional action required
}

// risk level either SAFE or RISK
enum RiskLevel {
  SAFE
  RISK
}
